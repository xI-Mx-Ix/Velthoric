name: Nightly Build

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Compile and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to update the release tag and upload files

    steps:
      # Step 1: Download the source code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Java 21 with Gradle caching for faster builds
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # Step 3: Ensure the Gradle wrapper is executable
      - name: Grant Execute Permissions
        run: chmod +x gradlew

      # Step 4: Run the build process
      - name: Build with Gradle
        run: ./gradlew build

      # Step 5: Upload internal artifacts (stored in the Actions tab for 7 days)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Velthoric-Build-${{ github.sha }}
          path: |
            fabric/build/libs/*.jar
            forge/build/libs/*.jar
            common/build/libs/*.jar
          retention-days: 7

      # Step 6: Create or update the public "nightly" pre-release
      # This will overwrite the files under the "nightly" tag on every push
      - name: Update Nightly Pre-Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "nightly"
          prerelease: true
          title: "Development Build (Nightly)"
          files: |
            fabric/build/libs/*.jar
            forge/build/libs/*.jar
            common/build/libs/*.jar